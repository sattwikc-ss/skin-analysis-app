<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü©∫ Skin Disease Classifier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üåô</span>
    </button>

    <div class="container">
        <header>
            <h1>ü©∫ Skin Disease Classifier</h1>
            <p class="subtitle">Upload an image to identify potential skin conditions</p>
        </header>

        <div class="card">
            <h2>Upload Your Image</h2>
            <form action="/" method="post" enctype="multipart/form-data" id="upload-form">
                <div class="upload-area" id="drop-area">
                    <div class="upload-icon">üì∑</div>
                    <p>Drag & drop an image here or click to browse</p>
                    <input type="file" name="file" id="file-input" class="file-input" accept="image/*" required>
                    <p class="file-name" id="file-name">No file selected</p>
                </div>
                <button type="submit" class="button" id="submit-btn">
                    <span>üîç Analyze Image</span>
                </button>
            </form>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing image...</p>
            </div>
        </div>

        {% if image_path %}
        <div class="card">
            <h2>Analysis Results</h2>
            <div class="result-container">
                <div class="image-preview">
                    <img src="{{ image_path }}" alt="Uploaded Image">
                </div>
                <div class="prediction-details">
                    <h3>Diagnosis</h3>
                    <div class="prediction-label">{{ predicted_class }}</div>
                    
                    <h4>Confidence Level</h4>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: {{ confidence }}%">
                            {{ confidence|round(2) }}%
                        </div>
                    </div>
                    
                    {% if disease_info %}
                    <div class="disease-info-container">
                        <div class="tabs">
                            <div class="tab active" data-tab="about">About</div>
                            <div class="tab" data-tab="symptoms">Symptoms</div>
                            <div class="tab" data-tab="treatments">Treatments</div>
                            <div class="tab" data-tab="prevention">Prevention</div>
                        </div>
                        
                        <div class="tab-content active" id="about-tab">
                            <div class="disease-info">
                                <h4>About {{ predicted_class }}</h4>
                                <p>{{ disease_info.description }}</p>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="symptoms-tab">
                            <div class="disease-info">
                                <h4>Common Symptoms</h4>
                                <p>{{ disease_info.symptoms }}</p>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="treatments-tab">
                            <div class="disease-info">
                                <h4>Treatment Options</h4>
                                <p>{{ disease_info.treatments }}</p>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="prevention-tab">
                            <div class="disease-info">
                                <h4>Prevention Measures</h4>
                                <p>{{ disease_info.prevention }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="actions-bar">
                        <button class="button" onclick="exportResults('{{ analysis_id }}')">
                            üì• Export Results
                        </button>
                        <button class="button secondary-button" onclick="addNotes('{{ analysis_id }}')">
                            üìù Add Notes
                        </button>
                    </div>
                    
                    <p class="warning-note"><strong>Note:</strong> This is an AI-assisted analysis and should not replace professional medical advice. Please consult with a dermatologist for proper diagnosis.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- History Section -->
        {% if history %}
        <div class="card history-section">
            <h2>Recent Analysis History</h2>
            <div class="history-container">
                {% for item in history %}
                <div class="history-item" onclick="window.location.href='/?analysis_id={{ item.id }}'">
                    <img src="{{ item.image_path }}" alt="History Image" class="history-image">
                    <div class="history-details">
                        <div class="history-date">{{ item.timestamp.split('T')[0] }}</div>
                        <div class="history-diagnosis">{{ item.disease_class }}</div>
                        <div class="history-confidence">{{ item.confidence|round(2) }}%</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button class="button secondary-button clear-history" onclick="confirmClearHistory()">
                üóëÔ∏è Clear History
            </button>
            <button class="button secondary-button" onclick="window.location.href='/history'">
                üìã View All History
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2>Export Results</h2>
            <p>Choose your preferred format:</p>
            <div style="margin-top: 20px;">
                <button class="button" onclick="downloadPDF()">
                    PDF Document
                </button>
                <button class="button" style="margin-left: 10px;" onclick="downloadJSON()">
                    JSON Data
                </button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal" id="notes-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2>Add Notes</h2>
            <textarea id="notes-text" rows="6" style="width: 100%; margin: 15px 0; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);"></textarea>
            <button class="button" onclick="saveNotes()">
                Save Notes
            </button>
        </div>
    </div>

    <script>
        // Current analysis ID for operations
        let currentAnalysisId = "{{ analysis_id if analysis_id else '' }}";
        
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Load saved theme preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
            
            // File input handling
            const fileInput = document.getElementById('file-input');
            const fileName = document.getElementById('file-name');
            const dropArea = document.getElementById('drop-area');
            const uploadForm = document.getElementById('upload-form');
            const submitBtn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            
            if (fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        fileName.textContent = this.files[0].name;
                        
                        // Preview image
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.createElement('img');
                            preview.src = e.target.result;
                            preview.style.maxHeight = '150px';
                            preview.style.margin = '10px auto';
                            
                            // Remove any existing preview
                            const existingPreview = dropArea.querySelector('img');
                            if (existingPreview) {
                                existingPreview.remove();
                            }
                            
                            dropArea.appendChild(preview);
                        }
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
            
            // Drag and drop functionality
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.style.borderColor = 'var(--primary-color)';
                    dropArea.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                }
                
                function unhighlight() {
                    dropArea.style.borderColor = 'var(--border-color)';
                    dropArea.style.backgroundColor = 'transparent';
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    fileInput.files = files;
                    
                    // Trigger change event to update preview
                    const event = new Event('change');
                    fileInput.dispatchEvent(event);
                }
            }
            
            // Show loading spinner on form submit
            if (uploadForm) {
                uploadForm.addEventListener('submit', function() {
                    submitBtn.style.display = 'none';
                    loading.style.display = 'block';
                });
            }
            
            // Tab functionality
            const tabs = document.querySelectorAll('.tab');
            if (tabs.length > 0) {
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Hide all tab content
                        document.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        
                        // Show the corresponding tab content
                        const tabId = tab.getAttribute('data-tab');
                        document.getElementById(tabId + '-tab').classList.add('active');
                    });
                });
            }
        });
        
        // Export functionality
        function exportResults(analysisId) {
            currentAnalysisId = analysisId;
            document.getElementById('export-modal').style.display = 'flex';
        }
        
        // Add notes functionality
        function addNotes(analysisId) {
            currentAnalysisId = analysisId;
            document.getElementById('notes-modal').style.display = 'flex';
            
            // Load existing notes
            fetch(`/api/export/${analysisId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.analysis && data.analysis.notes) {
                        document.getElementById('notes-text').value = data.analysis.notes;
                    }
                });
        }
        
        function saveNotes() {
            const notes = document.getElementById('notes-text').value;
            
            fetch(`/api/notes/${currentAnalysisId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ notes: notes }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    // Optionally refresh the page
                    // window.location.reload();
                }
            });
        }
        
        function closeModal() {
            document.getElementById('export-modal').style.display = 'none';
            document.getElementById('notes-modal').style.display = 'none';
        }
        
        function downloadPDF() {
            window.location.href = `/api/export/${currentAnalysisId}/pdf`;
        }
        
        function downloadJSON() {
            window.location.href = `/api/export/${currentAnalysisId}`;
        }
        
        function confirmClearHistory() {
            if (confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
                clearHistory();
            }
        }
        
        function clearHistory() {
            fetch('/api/history/clear', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>
