<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis History - Skin Disease Classifier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">üåô</span>
    </button>

    <div class="container">
        <header>
            <h1>Analysis History</h1>
            <p class="subtitle">View and manage your past skin analysis results</p>
        </header>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>All Analysis Records</h2>
                <button class="button secondary-button" onclick="window.location.href='/'">
                    ‚Üê Back to Analyzer
                </button>
            </div>
            
            {% if history %}
            <div class="history-container" style="margin-top: 30px;">
                {% for item in history %}
                <div class="history-item" id="history-{{ item.id }}">
                    <div style="position: relative;">
                        <img src="{{ item.image_path }}" alt="History Image" class="history-image">
                        <button 
                            onclick="deleteItem('{{ item.id }}')" 
                            style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            √ó
                        </button>
                    </div>
                    <div class="history-details">
                        <div class="history-date">{{ item.timestamp.split('T')[0] }}</div>
                        <div class="history-diagnosis">{{ item.disease_class }}</div>
                        <div class="history-confidence">{{ item.confidence|round(2) }}%</div>
                        
                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                            <button 
                                onclick="window.location.href='/?analysis_id={{ item.id }}'" 
                                style="background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">
                                View
                            </button>
                            <button 
                                onclick="exportResults('{{ item.id }}')" 
                                style="background: var(--info-color); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">
                                Export
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button class="button danger-button" onclick="confirmClearHistory()">
                    üóëÔ∏è Clear All History
                </button>
            </div>
            {% else %}
            <div style="text-align: center; padding: 50px 0;">
                <p>No analysis history found. Upload an image to get started.</p>
                <button class="button" style="margin-top: 20px;" onclick="window.location.href='/'">
                    Upload Image
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2>Export Results</h2>
            <p>Choose your preferred format:</p>
            <div style="margin-top: 20px;">
                <button class="button" onclick="downloadPDF()">
                    PDF Document
                </button>
                <button class="button" style="margin-left: 10px;" onclick="downloadJSON()">
                    JSON Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // Current analysis ID for operations
        let currentAnalysisId = "";
        
        // Theme toggle functionality
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Load saved theme preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            }
        });
        
        function exportResults(analysisId) {
            currentAnalysisId = analysisId;
            document.getElementById('export-modal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('export-modal').style.display = 'none';
        }
        
        function downloadPDF() {
            window.location.href = `/api/export/${currentAnalysisId}/pdf`;
        }
        
        function downloadJSON() {
            window.location.href = `/api/export/${currentAnalysisId}`;
        }
        
        function deleteItem(itemId) {
            if (confirm('Are you sure you want to delete this analysis?')) {
                fetch(`/api/history/${itemId}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the item from the DOM
                        document.getElementById(`history-${itemId}`).remove();
                    }
                });
            }
        }
        
        function confirmClearHistory() {
            if (confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
                clearHistory();
            }
        }
        
        function clearHistory() {
            fetch('/api/history/clear', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>
